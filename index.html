<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Synthia</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="Scott Davis <scott@thirstyhead.com>">
    <meta name="description" content="">
    <meta name="keywords" content="">

    <style>
      label{
        display: block;
        font-weight: bold;
        color: blue;
      }

      label::after{
        content: ":";
      }
    </style>
    
    <script>
      let voices = undefined;
      window.addEventListener('load', init);

      async function init(){
        const speechForm = document.querySelector('#speechForm');
        const speechSettingsForm = document.querySelector('#speechSettingsForm');

        speechForm.addEventListener('submit', (event) => {
          event.preventDefault();
          const fields = new FormData(speechForm);
          const settings = new FormData(speechSettingsForm);
          const options = {
            rate: settings.get('rate'),
            pitch: settings.get('pitch'),
            volume: settings.get('volume'),
            voice: settings.get('voice')
          }
          speak(fields.get('text-to-speak'), options);
        });

        speechSettingsForm.addEventListener('submit', (event) => {
          event.preventDefault();
        });
        speechSettingsForm.addEventListener('input', setOutputDisplay); 
        speechSettingsForm.addEventListener('change', setOutputDisplay); 
        speechSettingsForm.addEventListener('reset', setOutputDisplay); 

        voices = await getVoices();
        showVoices();
        setOutputDisplay();
      }


      function speak(message, options){
        let utterance = new SpeechSynthesisUtterance(message);
        utterance.rate = options.rate;
        utterance.pitch = options.pitch;
        utterance.volume = options.volume;
        utterance.voice = getVoice(options.voice);
        window.speechSynthesis.speak(utterance);
      }

      function setOutputDisplay(event){
        const settings = new FormData(speechSettingsForm);

        const rateOutput = document.querySelector('#rateOutput');
        rateOutput.value = settings.get('rate') || 1;

        const pitchOutput = document.querySelector('#pitchOutput');
        pitchOutput.value = settings.get('pitch') || 1;

        const volumeOutput = document.querySelector('#volumeOutput');
        volumeOutput.value = settings.get('volume') || 1;

        const voiceOutput = document.querySelector('#voiceOutput');
        voiceOutput.value = settings.get('voice');
      }

      // speechSynthesis.getVoices() is asynchronous on some browsers
      // this function normalizes it across all browsers
      function getVoices(){
        return new Promise( (resolve) => {
          voices = window.speechSynthesis.getVoices();
          if(voices.length){
            resolve(voices);
            return;
          }

          window.speechSynthesis.addEventListener('voiceschanged', () => {
            voices = window.speechSynthesis.getVoices();
            resolve(voices);
          });
        });
      }

      function getVoice(voiceName){
        return voices.find( (voice) => voice.name === voiceName );
      }

      function showVoices(){
        let voiceOptions = [];
        voices.sort( (a,b) => {
          if(a.lang < b.lang) return -1;
          if(a.lang > b.lang) return 1;
          return 0;
        });
        voices.forEach( (voice) => {
          let option = document.createElement('option');
          option.value = voice.name;
          option.innerText = `${voice.name} (${voice.lang})`;
          if(voice.default){
            option.setAttribute('selected', '');
          }
          voiceOptions.push(option);
        });

        let voiceField = document.querySelector('#voice');
        voiceField.innerHTML = '';
        voiceOptions.forEach( (option) => {
          voiceField.insertAdjacentElement('beforeend', option);
        });
      }
    </script>
  </head>

  <body>
    <h1>Hey, Synthia!</h1>
    <form id="speechForm">
      <input type="submit" 
             id="speakButton"
             value="Speak"></input>
      <input type="reset"
             value="Reset"></input>
      <p>
        <label for="textToSpeak">Text to Speak</label>
        <textarea name="text-to-speak" 
                  id="textToSpeak" 
                  rows="10"></textarea>
      </p>
    </form>

    <hr>
    <h2>Speech Settings</h2>
    <form id="speechSettingsForm">
      <input type="reset"
             value="Reset"></input>

      <p>
        <!-- NOTE: valid range for rate is a float [0.1 .. 10] -->
        <label for="rate">Rate</label>
        0.1
        <input type="range"
               name="rate"
               id="rate"
               value="1"
               min="0.1"
               max="10"
               step="0.1">
        10

        <br>
        Current value:
        <output for="rate"
                name="rate-output"
                id="rateOutput"
                value="1">1</output>
      </p>

      <p>
        <!-- NOTE: valid range for pitch is a float [0 .. 2] -->
        <label for="pitch">Pitch</label>
        0.1
        <input type="range"
               name="pitch"
               id="pitch"
               value="1"
               min="0.1"
               max="2"
               step="0.1">
        2

        <br>
        Current value: 
        <output for="pitch"
                name="pitch-output"
                id="pitchOutput"
                value="1">1</output>
      </p>

      <p>
        <!-- NOTE: valid range for volume is a float [0 .. 1] -->
        <label for="volume">Volume</label>
        0.1
        <input type="range"
               name="volume"
               id="volume"
               value="1"
               min="0.1"
               max="1"
               step="0.1">
        1

        <br>
        Current value: 
        <output for="volume"
                name="volume-output"
                id="volumeOutput"
                value="1">1</output>
      </p>

      <p>
        <label for="voice">Voice</label>
        <select name="voice"
                id="voice"
                size="10"></select>
        <br>
        Current value: 
        <output for="voice"
                name="voice-output"
                id="voiceOutput"
                value=""></output>
      </p>
    </form>











  </body>
</html>
